# ğŸ¬ Timelapse Image Aligner

íƒ€ì„ë©ìŠ¤ ì´¬ì˜ ì´ë¯¸ì§€ì˜ í”ë“¤ë¦¼ì„ ë³´ì •í•˜ê³  ì˜ìƒìœ¼ë¡œ ë§Œë“œëŠ” ë„êµ¬ ëª¨ìŒì…ë‹ˆë‹¤.

---

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
aligner/
â”œâ”€â”€ stabilize_phase.py       # ë©”ì¸: ìë™ í”ë“¤ë¦¼ + íšŒì „ ë³´ì •
â”œâ”€â”€ create_video.py          # ì˜ìƒ ìƒì„± (ë°°ì¹˜ ì²˜ë¦¬)
â”œâ”€â”€ requirements.txt         # Python ì˜ì¡´ì„±
â”œâ”€â”€ README.md
â””â”€â”€ util/                    # ìœ í‹¸ë¦¬í‹° ë° ê°œë°œìš© ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ manual_align_gui.py  # ìˆ˜ë™ ì •ë ¬ GUI
    â”œâ”€â”€ review_outliers.py   # ì•„ì›ƒë¼ì´ì–´ ê²€í† 
    â”œâ”€â”€ refine_day_alignment.py  # ë‚ ì§œë³„ ë³´ì • (ë‹¨ë… ì‹¤í–‰ìš©)
    â”œâ”€â”€ stabilize_neighbor.py    # (ê°œë°œìš©) ì´ì›ƒ ì •ë ¬ í…ŒìŠ¤íŠ¸
    â”œâ”€â”€ check_alignment.py       # (ê°œë°œìš©) ì •í•© ê²€ì¦
    â””â”€â”€ test_outlier_align.py    # (ê°œë°œìš©) ì•„ì›ƒë¼ì´ì–´ í…ŒìŠ¤íŠ¸
```

---

## ğŸ”§ ì„¤ì¹˜

### í•„ìˆ˜ ìš”êµ¬ì‚¬í•­
- Python 3.8+
- FFmpeg (ì‹œìŠ¤í…œ PATHì— ì„¤ì¹˜)

### Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
pip install -r requirements.txt
```

---

## ğŸ› ï¸ ë„êµ¬ ì„¤ëª…

### 1. `stabilize_phase.py` - ìë™ í”ë“¤ë¦¼ ë³´ì • (ë©”ì¸)

Phase Correlation + ECC ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì‹œí€€ìŠ¤ì˜ í”ë“¤ë¦¼ê³¼ íšŒì „ì„ ìë™ìœ¼ë¡œ ë³´ì •í•©ë‹ˆë‹¤.

**ì•Œê³ ë¦¬ì¦˜ (3ë‹¨ê³„ íŒŒì´í”„ë¼ì¸):**

1. **Chained Neighbor Alignment**: ì´ì›ƒ í”„ë ˆì„ ê°„ ì´ë™ëŸ‰ ê³„ì‚° ë° ëˆ„ì 
2. **Rotation Correction**: íšŒì „ì´ ê°ì§€ë˜ë©´ ECCë¡œ ë³´ì • (threshold: 0.1Â°)
3. **Day-level Refinement**: ë‚ ì§œ ê°„ ëœë¤ ìƒ˜í”Œë§ìœ¼ë¡œ ë“œë¦¬í”„íŠ¸ ë³´ì •

**í•µì‹¬ ê¸°ëŠ¥:**
| ê¸°ëŠ¥ | ì„¤ëª… |
|------|------|
| Chained Alignment | ì´ì›ƒ í”„ë ˆì„ ê°„ ì •ë ¬ë¡œ ë¶€ë“œëŸ¬ìš´ ê²°ê³¼ |
| Rotation Correction | 0.1Â° ì´ìƒ íšŒì „ ì‹œ ECCë¡œ ìë™ ë³´ì • |
| Deadzone Damping | Â±3px ë‚´ì—ì„œëŠ” ììœ , ì´ˆê³¼ ì‹œ 0.99 ê³„ìˆ˜ë¡œ ì›ì  ë³µê·€ |
| Day Refinement | ë‚ ì§œ ê°„ 30ê°œ ëœë¤ ìƒ˜í”Œ ë¹„êµë¡œ ë“œë¦¬í”„íŠ¸ ì œê±° |

**ì‚¬ìš©ë²•:**
```bash
# ê¸°ë³¸ ì‹¤í–‰ (input â†’ output, Day Refinement í¬í•¨)
python stabilize_phase.py

# ì»¤ìŠ¤í…€ í´ë” ì§€ì •
python stabilize_phase.py -i my_input -o my_output

# ë³´ì • + ì˜ìƒ ìƒì„±ê¹Œì§€
python stabilize_phase.py --video

# ê³ í’ˆì§ˆ ì˜ìƒ
python stabilize_phase.py --video --fps 30 --crf 18

# Day Refinement ê±´ë„ˆë›°ê¸°
python stabilize_phase.py --no-refine
```

**ì˜µì…˜:**
| ì˜µì…˜ | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `-i`, `--input` | ì…ë ¥ í´ë” | `input` |
| `-o`, `--output` | ì¶œë ¥ í´ë” | `output` |
| `--ext` | ì´ë¯¸ì§€ í™•ì¥ì | `jpg` |
| `-v`, `--video` | í†µí•© MP4 ìƒì„± | êº¼ì§ |
| `--fps` | ì˜ìƒ FPS | `30` |
| `--crf` | ì˜ìƒ í’ˆì§ˆ (0-51, ë‚®ì„ìˆ˜ë¡ ê³ í’ˆì§ˆ) | `18` |
| `--batch` | ì˜ìƒ ë°°ì¹˜ë‹¹ ì´ë¯¸ì§€ ìˆ˜ | `500` |
| `--no-refine` | Day-level Refinement ê±´ë„ˆë›°ê¸° | êº¼ì§ |

**í•˜ìœ„ í´ë” ìë™ ì²˜ë¦¬:**

ë‚ ì§œë³„ë¡œ í´ë”ê°€ ë¶„ë¦¬ëœ ê²½ìš°, ìë™ìœ¼ë¡œ ì²´ì¸ ì—°ê²°í•˜ì—¬ ì²˜ë¦¬í•©ë‹ˆë‹¤.

```
input/                    output/
â”œâ”€â”€ 2026-01-01/    â†’     â”œâ”€â”€ 2026-01-01/
â”œâ”€â”€ 2026-01-02/    â†’     â”œâ”€â”€ 2026-01-02/
â””â”€â”€ 2026-01-03/    â†’     â”œâ”€â”€ 2026-01-03/
                         â”œâ”€â”€ logs/
                         â”‚   â”œâ”€â”€ [timestamp]_full.txt
                         â”‚   â””â”€â”€ [timestamp]_outliers.txt
                         â””â”€â”€ combined_all.mp4
```

**ì¶œë ¥ íŒŒì¼:**
| íŒŒì¼ | ì„¤ëª… |
|------|------|
| `output/[í´ë”]/[ì´ë¯¸ì§€].jpg` | ë³´ì •ëœ ì´ë¯¸ì§€ |
| `output/logs/[timestamp]_full.txt` | ì „ì²´ ë³´ì • ë¡œê·¸ |
| `output/logs/[timestamp]_outliers.txt` | ì•„ì›ƒë¼ì´ì–´ ëª©ë¡ |
| `output/combined_all.mp4` | í†µí•© ì˜ìƒ (--video ì˜µì…˜) |

**ì„¤ì •ê°’:**
| í•­ëª© | ê°’ | ì„¤ëª… |
|------|-----|------|
| Rotation Threshold | 0.1Â° | ì´ ì´ìƒ íšŒì „ ì‹œ ECC ë³´ì • |
| Damping Deadzone | 3px | ì´ ë²”ìœ„ ë‚´ì—ì„œëŠ” Damping ë¯¸ì ìš© |
| Damping Factor | 0.99 | í”„ë ˆì„ë‹¹ 1% ì›ì  ë³µê·€ |
| Day Refine Samples | 30 | ë‚ ì§œë‹¹ ëœë¤ ìƒ˜í”Œ ìˆ˜ |

---

### 2. `refine_day_alignment.py` - ë‚ ì§œë³„ ë³´ì • í›„ì²˜ë¦¬

ì´ë¯¸ ë³´ì •ëœ ì´ë¯¸ì§€ì— ë‚ ì§œë³„ ì˜¤í”„ì…‹ ë³´ì •ì„ ì¶”ê°€ë¡œ ì ìš©í•©ë‹ˆë‹¤.
(`stabilize_phase.py`ì— í†µí•©ë˜ì–´ ìˆì§€ë§Œ, ë‹¨ë… ì‹¤í–‰ë„ ê°€ëŠ¥)

**ì‚¬ìš©ë²•:**
```bash
python refine_day_alignment.py
```

---

### 3. `create_video.py` - ë©”ëª¨ë¦¬ íš¨ìœ¨ì  ì˜ìƒ ìƒì„±

ëŒ€ëŸ‰ì˜ ì´ë¯¸ì§€ë¥¼ ë°°ì¹˜ë¡œ ë‚˜ëˆ  ì²˜ë¦¬í•˜ì—¬ ë©”ëª¨ë¦¬ ë¶€ì¡± ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.

**ë™ì‘ ì›ë¦¬:**
1. ì´ë¯¸ì§€ë¥¼ ë°°ì¹˜(ê¸°ë³¸ 200ì¥)ë¡œ ë¶„í• 
2. ê° ë°°ì¹˜ë¥¼ ê°œë³„ MP4ë¡œ ì¸ì½”ë”©
3. ìƒì„±ëœ MP4ë“¤ì„ ìŠ¤íŠ¸ë¦¼ ë³µì‚¬ë¡œ ë¹ ë¥´ê²Œ ë³‘í•©
4. ì„ì‹œ íŒŒì¼ ìë™ ì •ë¦¬

**ì‚¬ìš©ë²•:**
```bash
python create_video.py --input INPUT_FOLDER --output OUTPUT.mp4 [OPTIONS]
```

**ì˜µì…˜:**
| ì˜µì…˜ | ì„¤ëª… | ê¸°ë³¸ê°’ |
|------|------|--------|
| `--input`, `-i` | ì…ë ¥ ì´ë¯¸ì§€ í´ë” | (í•„ìˆ˜) |
| `--output`, `-o` | ì¶œë ¥ ì˜ìƒ íŒŒì¼ | `output.mp4` |
| `--fps` | ì´ˆë‹¹ í”„ë ˆì„ ìˆ˜ | `30` |
| `--crf` | í’ˆì§ˆ (0-51, ë‚®ì„ìˆ˜ë¡ ê³ í’ˆì§ˆ) | `18` |
| `--batch` | ë°°ì¹˜ë‹¹ ì´ë¯¸ì§€ ìˆ˜ | `200` |
| `--ext` | ì´ë¯¸ì§€ í™•ì¥ì | `jpg` |

---

### 4. `util/manual_align_gui.py` - ìˆ˜ë™ ì •ë ¬ GUI

ë‘ ì´ë¯¸ì§€ë¥¼ ë¹„êµí•˜ë©° ìˆ˜ë™ìœ¼ë¡œ ì •ë ¬ ì˜¤í”„ì…‹ì„ ì¡°ì •í•˜ëŠ” GUI ë„êµ¬ì…ë‹ˆë‹¤.

**ê¸°ëŠ¥:**
- **Main View**: ì „ì²´ ì´ë¯¸ì§€ í‘œì‹œ
- **Zoom View**: ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€ 4ë°° í™•ëŒ€
- í† ê¸€/ì˜¤ë²„ë ˆì´ë¡œ ì •ë°€ ë¹„êµ ê°€ëŠ¥

**ì¡°ì‘ë²•:**
| í‚¤ | ë™ì‘ |
|---|---|
| `W` / `A` / `S` / `D` | 1px ì´ë™ (ìƒ/ì¢Œ/í•˜/ìš°) |
| `I` / `J` / `K` / `L` | 10px ì´ë™ (ìƒ/ì¢Œ/í•˜/ìš°) |
| `Arrow Keys` | 0.1px ì´ë™ |
| `Shift + Arrow` | 0.01px ì´ë™ |
| `SPACE` | Reference â†” Aligned í† ê¸€ |
| `Z` | Overlay ëª¨ë“œ (ë°˜íˆ¬ëª… ê²¹ì¹¨) |
| `ë§ˆìš°ìŠ¤ ì´ë™` | í™•ëŒ€ ìœ„ì¹˜ ì§€ì • |
| `Q` / `ESC` | ì¢…ë£Œ (ì˜¤í”„ì…‹ ì¶œë ¥) |

**ì‚¬ìš©ë²•:**
```bash
# ë‘ ì´ë¯¸ì§€ ì§ì ‘ ì§€ì •
python util/manual_align_gui.py --ref reference.jpg --mov moving.jpg

# í´ë”ì˜ ì²˜ìŒ ë‘ ì´ë¯¸ì§€ ì‚¬ìš©
python util/manual_align_gui.py --input-dir input
```

---

### 5. `util/review_outliers.py` - ì•„ì›ƒë¼ì´ì–´ ê²€í†  ë° GT ìˆ˜ì§‘

ë¡œê·¸ì— ê¸°ë¡ëœ ìŠ¤í‚µëœ í”„ë ˆì„ë“¤ì„ ìˆ˜ë™ìœ¼ë¡œ ê²€í† í•˜ê³ , Ground Truthë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.

**ì‚¬ìš©ë²•:**
```bash
python util/review_outliers.py --log output/logs/[timestamp]_outliers.txt
```

---

## ğŸ“‹ ì¼ë°˜ì ì¸ ì›Œí¬í”Œë¡œìš°

### 1. ì™„ì „ ìë™ (ê¶Œì¥)

```bash
# Step 1: ì´ë¯¸ì§€ í´ë”ë¥¼ inputì— ë³µì‚¬
# input/2026-01-01/, input/2026-01-02/, ...

# Step 2: ìë™ ë³´ì • + ì˜ìƒ ìƒì„±
python stabilize_phase.py --video --fps 30 --crf 23
```

### 2. ë‹¨ê³„ë³„ ì‹¤í–‰

```bash
# Step 1: ë³´ì •ë§Œ ì‹¤í–‰
python stabilize_phase.py

# Step 2: ê²°ê³¼ í™•ì¸ (GUI)
python util/manual_align_gui.py --ref output/2026-01-01/img1.jpg --mov output/2026-01-01/img2.jpg

# Step 3: ì˜ìƒ ìƒì„±
python create_video.py -i output -o timelapse.mp4 --fps 30
```

### 3. ì•„ì›ƒë¼ì´ì–´ ê²€í† 

```bash
# outliers.txt í™•ì¸ í›„ ìˆ˜ë™ ê²€í† 
python util/review_outliers.py --log output/logs/[timestamp]_outliers.txt
```

---

## ğŸ“„ ë¡œê·¸ íŒŒì¼ í˜•ì‹

### `output/logs/[timestamp]_full.txt`
```
# Stabilization Log
# Execution: 2026-01-30_10-45
# Date Range: 2026-01-01 to 2026-01-28
# Method: Chained Neighbor + Rotation Correction + Day Refinement
# Rotation Threshold: 0.1Â°
# Damping: Deadzone=3.0px, Factor=0.99

2026-01-01	2026-01-01_06-00-00.jpg	dx=0.0	dy=0.0	resp=1.000	status=FIRST
2026-01-01	2026-01-01_06-06-00.jpg	dx=0.2	dy=0.1	resp=0.845	status=OK
2026-01-28	2026-01-28_14-00-00.jpg	dx=-5.2	dy=3.1	resp=0.712	status=ROT(0.18Â°)
```

### `output/logs/[timestamp]_outliers.txt`
```
# Outlier Report
# Total outliers: 2

2026-01-15	2026-01-15_06-12-00.jpg	dx=152.3, dy=87.2, resp=0.021
```

---

## âš™ï¸ CRF í’ˆì§ˆ ê°€ì´ë“œ

| CRF | ì„¤ëª… | ìš©ë„ |
|-----|------|------|
| 0 | ë¬´ì†ì‹¤ | ì•„ì¹´ì´ë¸Œ |
| 12-14 | ë§¤ìš° ê³ í’ˆì§ˆ | ì „ë¬¸ê°€ìš© |
| **18** | ê³ í’ˆì§ˆ (ê¸°ë³¸ê°’) | ì¼ë°˜ ì‚¬ìš© |
| **23** | ì¤‘ê°„ í’ˆì§ˆ | ì›¹ ì—…ë¡œë“œ (ê¶Œì¥) |
| 28+ | ì €í’ˆì§ˆ | ë¯¸ë¦¬ë³´ê¸° |

---

## ğŸš¨ ë¬¸ì œ í•´ê²°

### FFmpeg ë©”ëª¨ë¦¬ ë¶€ì¡±
```bash
python stabilize_phase.py --video --batch 100
```

### ì˜ìƒ ì¬ìƒ ëŠê¹€
- í•´ìƒë„ê°€ ë„ˆë¬´ í¼ (4K ì´ìƒ) â†’ ìë™ìœ¼ë¡œ 1080pë¡œ ë‹¤ìš´ìŠ¤ì¼€ì¼ë¨
- CRF ë‚®ì¶”ê¸°: `--crf 23`

### íŠ¹ì • ë‚ ì§œë§Œ í”ë“¤ë¦¼ì´ ì‹¬í•¨
- íšŒì „ ë³´ì • ë¡œê·¸ í™•ì¸: `status=ROT(0.18Â°)`
- í•´ë‹¹ ë‚ ì§œ ì›ë³¸ ì´ë¯¸ì§€ í™•ì¸ (ë°”ëŒ, ì§„ë™ ë“±)

### ë‚ ì§œ ê°„ ì í”„ ë°œìƒ
- Day Refinementê°€ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸
- `--no-refine` ì˜µì…˜ì´ ìˆìœ¼ë©´ ì œê±°

---

## ğŸ“ ë¼ì´ì„ ìŠ¤

ê°œì¸ ë° ìƒì—…ì  ì‚¬ìš© ììœ 

# Timelapse Auto-Stabilizer

íƒ€ì„ë©ìŠ¤ ì´ë¯¸ì§€ ì‹œí€€ìŠ¤ì˜ í”ë“¤ë¦¼(Translation)ê³¼ íšŒì „(Rotation)ì„ ìë™ìœ¼ë¡œ ë³´ì •í•˜ì—¬ ë¶€ë“œëŸ¬ìš´ ì˜ìƒì„ ìƒì„±í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤. ëŒ€ëŸ‰ì˜ ì´ë¯¸ì§€ë¥¼ ë³‘ë ¬ ì²˜ë¦¬í•˜ì—¬ ê³ ì†ìœ¼ë¡œ ì•ˆì •í™”í•©ë‹ˆë‹¤.

## âœ¨ ì£¼ìš” ê¸°ëŠ¥ (Key Features)
- **Zero Drift PID Control**: PID ì œì–´ê¸°(ë¹„ë¡€-ì ë¶„-ë¯¸ë¶„)ì™€ Global Anchor ì „ëµì„ í†µí•´ ì¥ê¸°ê°„ íƒ€ì„ë©ìŠ¤ì—ì„œë„ ë“œë¦¬í”„íŠ¸(ìœ„ì¹˜/íšŒì „ ëˆ„ì  ì˜¤ì°¨)ë¥¼ ì™„ë²½í•˜ê²Œ ì œê±°í•©ë‹ˆë‹¤.
- **Robust Rotation Correction**: Gradient ê¸°ë°˜ ECC ì•Œê³ ë¦¬ì¦˜(ê¸°ë³¸ 100 iter)ì„ ì‚¬ìš©í•˜ì—¬ ì¡°ëª… ë³€í™”ê°€ ì‹¬í•œ í™˜ê²½ì—ì„œë„ ë¯¸ì„¸í•œ íšŒì „ì„ ì •ë°€í•˜ê²Œ ê°ì§€í•©ë‹ˆë‹¤.
- **Smart Dark Removal**: ì´ë¯¸ì§€ ì¤‘ì‹¬ë¶€ ë°ê¸°ë¥¼ ë¶„ì„í•˜ì—¬ ë„ˆë¬´ ì–´ë‘ìš´(ë°¤/ìƒˆë²½) ì´ë¯¸ì§€ëŠ” ë¶„ì„ ë° ê²°ê³¼ì—ì„œ ìë™ìœ¼ë¡œ ì œì™¸í•©ë‹ˆë‹¤ (CLI ê¸°ë³¸ 60.0, GUI ê¸°ë³¸ 120).
- **Uniform Brightness**: ëª¨ë“  ê²°ê³¼ í”„ë ˆì„ì˜ ë°ê¸°ë¥¼ ê· ì¼í•˜ê²Œ ì •ê·œí™”í•˜ì—¬ í”Œë¦¬ì»¤(ê¹œë¹¡ì„) ì—†ëŠ” ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤ (CLI ê¸°ë³¸ 110, GUI ê¸°ë³¸ 160).
- **Subfolder & Range Support**: íŠ¹ì • í”„ë¡œì íŠ¸ í´ë” ë° ë‚ ì§œ ë²”ìœ„ë¥¼ ì§€ì •í•˜ì—¬ ë¶€ë¶„ ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- **Parallel Processing**: ë©€í‹°ì½”ì–´ë¥¼ í™œìš©í•œ ê³ ì† ë³‘ë ¬ ë¶„ì„ ë° ë Œë”ë§.
- **Manual Alignment (GUI)**: ë³€í™˜ ë¶„ì„ ê²°ê³¼ì—ì„œ ìˆ˜ë™ ì •ë ¬ì„ ë³´ì •í•˜ê³  ìƒíƒœ(Manual/Auto)ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- **Resuming**: ë‹¨ê³„ë³„ ë¶„ì„ ë¡œê·¸(JSON) ìë™ ì €ì¥ìœ¼ë¡œ ì¤‘ë‹¨ëœ ì§€ì ë¶€í„° ì¬ê°œ ê°€ëŠ¥ (CLI: analysis/refine/full log, GUI: step1_analysis/day_gaps ë“±).

## ğŸ“¦ ì„¤ì¹˜ (Installation)

### í•„ìš” ì¡°ê±´ (Prerequisites)
- Python 3.8+
- OpenCV (`opencv-python`, `opencv-contrib-python`)
- FFmpeg (ì‹œìŠ¤í…œ PATHì— ì„¤ì¹˜)

### Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
```bash
pip install -r requirements.txt
```

---

## ğŸš€ ì‚¬ìš©ë²• (Usage)

ì´ í”„ë¡œì íŠ¸ëŠ” **CLI(`timelapse_stabilizer.py`)**ì™€ **GUI(`gui_main.py`)** ë‘ ê°€ì§€ ì‹¤í–‰ ë°©ì‹ì´ ìˆìŠµë‹ˆë‹¤.

### GUI ì‹¤í–‰
```bash
python gui_main.py
```
GUIëŠ” ë‹¨ê³„ë³„ íŒŒì´í”„ë¼ì¸(ì „ì²˜ë¦¬/ë¶„ì„/ë°ê¸°/ë Œë”/ë¹„ë””ì˜¤)ì„ ì œê³µí•©ë‹ˆë‹¤.  
ë³€í™˜ ë¶„ì„ ê²°ê³¼ íƒ­ì—ì„œ **ìˆ˜ë™ ì •ë ¬ í¸ì§‘**ì„ ìˆ˜í–‰í•˜ë©´ day gapì— Manual ìƒíƒœê°€ ì €ì¥ë©ë‹ˆë‹¤.

### 1. ê¸°ë³¸ ì‹¤í–‰ (ì „ì²´ ì²˜ë¦¬)
`input/` ë£¨íŠ¸ í´ë” ë‚´ì˜ ëª¨ë“  ë‚ ì§œ í´ë”ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
```bash
python timelapse_stabilizer.py --video
```

### 2. íŠ¹ì • í”„ë¡œì íŠ¸(ì„œë¸Œí´ë”) ì‹¤í–‰
`input/MyProject/` í´ë” ë‚´ì˜ ì´ë¯¸ì§€ë“¤ì„ ì•ˆì •í™”í•˜ê³ , ê²°ê³¼ëŠ” `output/MyProject/`ì— ì €ì¥í•©ë‹ˆë‹¤.
ì˜ìƒ íŒŒì¼ëª…ì€ `MyProject_ë‚ ì§œë²”ìœ„_í•´ìƒë„_ì‹œê°„.mp4` í˜•ì‹ì„ ë”°ë¦…ë‹ˆë‹¤.
```bash
python timelapse_stabilizer.py --subfolder MyProject --video
```

### 3. ë‚ ì§œ ë²”ìœ„ ì§€ì • ë° ê³ í™”ì§ˆ ì„¤ì •
íŠ¹ì • ê¸°ê°„ë§Œ ì„ íƒí•˜ì—¬ ì²˜ë¦¬í•˜ê³ , 1080p í•´ìƒë„ë¡œ ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤.
```bash
python timelapse_stabilizer.py --subfolder MyProject --start 2026-01-05 --end 2026-01-10 --resize-width 1920 --video
```

### 4. ê²°ê³¼ í‰ê°€ (Evaluation)
ì•ˆì •í™” ê²°ê³¼ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•˜ê³ (dX, dY, Rot), ë¡œê·¸ì™€ íŒŒë¼ë¯¸í„°ë¥¼ `evaluation_reports/`ì— ë°±ì—…í•©ë‹ˆë‹¤.
```bash
# ì „ì²´ í‰ê°€
python evaluate_stabilization.py

# íŠ¹ì • í”„ë¡œì íŠ¸(ì„œë¸Œí´ë”) í‰ê°€
python evaluate_stabilization.py --subfolder MyProject
```

---

## âš™ï¸ ìƒì„¸ í”„ë¡œì„¸ìŠ¤ (Pipeline)

### 1. ì•Œê³ ë¦¬ì¦˜ ë‹¤ì´ì–´ê·¸ë¨ (Algorithm)
ì´ í”„ë¡œì íŠ¸ëŠ” **Gradient-based ECC** (íšŒì „ ì •ë°€ ê°ì§€)ì™€ **Zero-Drift PID Control** ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**1. ê°œë³„ í”„ë ˆì„ ë¶„ì„ (Analysis Logic):**
```text
[ì…ë ¥ ì´ë¯¸ì§€] 
    â”‚
    â–¼
[Center Crop ë°ê¸° ë¶„ì„] â”€â”€(Dark)â”€â”€> [ì œê±°/Skip]
    â”‚ (Pass)
    â–¼
[Gradient ë³€í™˜ (ì¡°ëª… ê°•ì¸ì„± í™•ë³´)]
    â”‚
    â”œâ”€â”€â”€> [ECC ì •ë°€ íšŒì „ ê°ì§€ (ê¸°ë³¸ 100iter)]
    â”‚           â”‚
    â”‚     [ì´ë¯¸ì§€ ì—­íšŒì „]
    â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€> [Phase Correlation] 
                      â”‚
            [ìµœì¢… ë³€ìœ„(dx, dy) ê³„ì‚°]
```

**2. ì „ì²´ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (Parallel Pipeline):**
```text
[Step 1: Analysis]   -> ê° í´ë” ë³‘ë ¬ ë¶„ì„ (Dark Filtering í¬í•¨) -> analysis_log.json / step1_analysis
        â”‚
[Step 2: Refinement] -> [Day 1 vs Day N] Global Anchor ì •í•© (ìƒ˜í”Œ ê¸°ë³¸ 5ì¥) -> refine_log.json / day_gaps.json
        â”‚
[Step 3: Integration]-> PID ì œì–´ê¸° ì ìš© (Smooth & Zero Drift) -> full_log.txt
        â”‚
[Step 4: Rendering]  -> [Warp] ë³€í™˜ + ë°ê¸° ì •ê·œí™” -> Output Images
```

---

## ğŸ“‚ íŒŒì¼ êµ¬ì¡° (File Structure)

```
project/
â”œâ”€â”€ timelapse_stabilizer.py   # [Main] ë³‘ë ¬ ì•ˆì •í™” ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ gui_main.py               # [GUI] ìˆ˜ë™ ë³´ì • í¬í•¨ GUI
â”œâ”€â”€ evaluate_stabilization.py # [New] ì•ˆì •í™” ì„±ëŠ¥ í‰ê°€ ë° ë¦¬í¬íŠ¸ ë„êµ¬
â”œâ”€â”€ create_video.py           # ë¹„ë””ì˜¤ ìƒì„± ìœ í‹¸ë¦¬í‹° (ëª¨ë“ˆ)
â”œâ”€â”€ dep/                      # êµ¬ë²„ì „ ìŠ¤í¬ë¦½íŠ¸ ë³´ê´€
â”œâ”€â”€ input/                    # ì…ë ¥ ì´ë¯¸ì§€ (êµ¬ì¡°: input/í”„ë¡œì íŠ¸ëª…/ë‚ ì§œë³„í´ë”)
â”œâ”€â”€ output/                   # ì¶œë ¥ ê²°ê³¼ë¬¼ (êµ¬ì¡°: output/í”„ë¡œì íŠ¸ëª…/)
â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸ëª…/            # CLI ì¶œë ¥
â”‚   â”‚   â”œâ”€â”€ 2026-01-01/       # ì•ˆì •í™”ëœ ì´ë¯¸ì§€ë“¤
â”‚   â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸ëª…_analysis_log.json
â”‚   â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸ëª…_refine_log.json
â”‚   â”‚   â”œâ”€â”€ í”„ë¡œì íŠ¸ëª…_full_log.txt
â”‚   â”‚   â””â”€â”€ í”„ë¡œì íŠ¸ëª…_2026-01-01~2026-01-31_1920p_180000.mp4
â”‚   â”œâ”€â”€ step1_analysis/       # GUI ì¶œë ¥ (ë¶„ì„ ë¡œê·¸)
â”‚   â”‚   â”œâ”€â”€ analysis_results.json
â”‚   â”‚   â””â”€â”€ day_gaps.json
â”‚   â”œâ”€â”€ step1_normalized/     # GUI ë°ê¸° ì •ê·œí™” ê²°ê³¼
â”‚   â”œâ”€â”€ step2_render/         # GUI ë Œë” ê²°ê³¼
â”‚   â””â”€â”€ step3_video/          # GUI ë¹„ë””ì˜¤ ê²°ê³¼
â””â”€â”€ evaluation_reports/       # í‰ê°€ ë¦¬í¬íŠ¸ ì•„ì¹´ì´ë¸Œ
```

## ğŸ“ ë¡œê·¸ íŒŒì¼ (Log Files)
ìƒì„¸ ë¶„ì„ ë°ì´í„°ëŠ” `output/í”„ë¡œì íŠ¸ëª…/` í´ë”ì— `[í”„ë¡œì íŠ¸]_` ì ‘ë‘ì–´ì™€ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.

**JSON ë¡œê·¸**: ì¬ê°œ(Resume)ë¥¼ ìœ„í•œ ì¤‘ê°„ ë°ì´í„°ì…ë‹ˆë‹¤.
**ìµœì¢… ë¡œê·¸ (`full_log.txt`)**:
- **dx/dy**: ìµœì¢… ë³´ì •ëœ ì´ë™ëŸ‰ (Absolute Pixels)
- **rot**: ìµœì¢… ë³´ì •ëœ íšŒì „ê° (Degree)
- **status**: `OK`, `DARK` (ì œê±°ë¨), `ROT(angle)` ë“± ìƒíƒœ ì •ë³´

---

## ğŸ› ï¸ ê³ ê¸‰ ì˜µì…˜ (Advanced Options)

### CLI ì˜µì…˜ (timelapse_stabilizer.py)
| ì˜µì…˜ | ì„¤ëª… | ì˜ˆì‹œ |
|---|---|---|
| `--input` (`-i`) | ì…ë ¥ ë£¨íŠ¸ ê²½ë¡œ | `-i input` |
| `--output` (`-o`) | ì¶œë ¥ ë£¨íŠ¸ ê²½ë¡œ | `-o output` |
| `--subfolder` (`-f`) | `input` ë‚´ì˜ íŠ¹ì • í”„ë¡œì íŠ¸ í´ë” ì§€ì • | `-f MyProject` |
| `--start` / `--end` | ì²˜ë¦¬í•  ë‚ ì§œ ë²”ìœ„ ì§€ì • (YYYY-MM-DD) | `--start 2026-01-01` |
| `--ext` | ì…ë ¥ ì´ë¯¸ì§€ í™•ì¥ì | `--ext jpg` |
| `--workers` (`-w`) | ë³‘ë ¬ ì›Œì»¤ ìˆ˜ | `-w 8` |
| `--resize-width` | ì˜ìƒ ê°€ë¡œ í•´ìƒë„ (ì„¸ë¡œ ìë™, ì˜ˆ: 1920) | `--resize-width 1920` |
| `--fps` | ë¹„ë””ì˜¤ FPS | `--fps 30` |
| `--force-analyze` | ê¸°ì¡´ ë¡œê·¸ ë¬´ì‹œí•˜ê³  ì „ì²´ ì¬ë¶„ì„ | `--force-analyze` |
| `--force-refine` | Day Gap ì¬ê³„ì‚° ê°•ì œ | `--force-refine` |
| `--render-only` | ë¶„ì„ëœ ë¡œê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë Œë”ë§ë§Œ ìˆ˜í–‰ | `--render-only` |
| `--video` | ë Œë” í›„ ë¹„ë””ì˜¤ ìƒì„± | `--video` |
| `--all-places` | input ë‚´ ëª¨ë“  ì„œë¸Œí´ë” ìˆœì°¨ ì²˜ë¦¬ | `--all-places` |

### GUI ì˜µì…˜ (gui_main.py)
- **ì „ì²˜ë¦¬**: ì–´ë‘ìš´ ì‚¬ì§„ ì œì™¸(ON/OFF), Threshold (ê¸°ë³¸ 120)
- **ë°ê¸° ì •ê·œí™”**: ON/OFF, Target (ê¸°ë³¸ 160)
- **ë¹„ë””ì˜¤**: FPS (ê¸°ë³¸ 30), CRF (ê¸°ë³¸ 18), Width (ì„ íƒ)
